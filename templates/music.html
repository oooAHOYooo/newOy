{% extends "base.html" %}

{% block title %}Music - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="music-container">
    <div class="music-header">
        <h1>Music Player</h1>
        
        <!-- Quick Stats -->
        <div class="music-stats">
            <div class="stat-item">
                <i class="fas fa-music"></i>
                <span>{{ songs|length }} Songs</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span>{{ songs|length * 3 }} Minutes</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-calendar"></i>
                <span>{{ songs|length }} Tracks</span>
            </div>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="search-filter-bar">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search songs, artists, or albums...">
            <button class="clear-search" title="Clear search">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="filter-group">
            <div class="genre-filter">
                <select id="genre-filter">
                    <option value="">All Genres</option>
                    {% set genres = [] %}
                    {% for song in songs %}
                        {% if song.genre not in genres %}
                            {% set _ = genres.append(song.genre) %}
                            <option value="{{ song.genre }}">{{ song.genre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Sort Controls -->
    <div class="sort-controls">
        <select id="sort-select">
            <option value="title">Sort by Title</option>
            <option value="artist">Sort by Artist</option>
            <option value="album">Sort by Album</option>
            <option value="duration">Sort by Duration</option>
        </select>
        <button id="sort-direction" title="Toggle sort direction">
            <i class="fas fa-sort-amount-down"></i>
        </button>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters">
        <div class="filter-tags"></div>
        <button class="clear-filters" style="display: none;">
            <i class="fas fa-times"></i> Clear All
        </button>
    </div>

    <!-- Table View -->
    <div class="songs-table">
        <table>
            <thead>
                <tr>
                    <th class="play-col"></th>
                    <th class="title-col" data-sort="title">Title</th>
                    <th class="artist-col" data-sort="artist">Artist</th>
                    <th class="album-col" data-sort="album">Album</th>
                    <th class="duration-col" data-sort="duration">Duration</th>
                    <th class="like-col"></th>
                    <th class="queue-col"></th>
                </tr>
            </thead>
            <tbody>
                {% for song in songs %}
                <tr class="song-row" data-song-id="{{ song.id }}"
                    data-title="{{ song.songTitle }}"
                    data-artist="{{ song.artist }}"
                    data-album="{{ song.album }}"
                    data-duration="{{ song.duration|default('3:45') }}"
                    data-genre="{{ song.genre }}">
                    <td class="play-col">
                        <button class="play-btn" data-song-url="{{ song.mp3url }}"
                                data-song-title="{{ song.songTitle }}"
                                data-artist="{{ song.artist }}"
                                data-album-art="{{ song.coverArt }}">
                            <i class="fas fa-play"></i>
                        </button>
                    </td>
                    <td class="title-col">
                        <div class="song-title">
                            <img src="{{ song.coverArt }}" alt="{{ song.songTitle }}" class="song-thumbnail">
                            <div class="title-info">
                                <span class="title" data-tooltip="{{ song.songTitle }}">{{ song.songTitle }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="artist-col">
                        <a href="{{ song.artistUrl }}" class="artist-link" target="_blank" data-tooltip="{{ song.artist }}">
                            {{ song.artist }}
                        </a>
                    </td>
                    <td class="album-col" data-tooltip="{{ song.album }}">{{ song.album }}</td>
                    <td class="duration-col">{{ song.duration|default('3:45') }}</td>
                    <td class="like-col">
                        <button class="like-btn" data-song-id="{{ song.id }}" data-tooltip="Add to Favorites">
                            <i class="far fa-heart"></i>
                        </button>
                    </td>
                    <td class="queue-col">
                        <button class="queue-btn" data-song-id="{{ song.id }}" data-tooltip="Add to Playlist">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- No Results Message -->
    <div class="no-results" style="display: none;">
        <i class="fas fa-search"></i>
        <h3>No songs found</h3>
        <p>Try adjusting your search or filters</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State management
    const state = {
        searchTerm: '',
        activeFilters: new Set(),
        sortBy: 'title',
        sortDirection: 'asc'
    };

    // DOM Elements
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.querySelector('.clear-search');
    const genreFilter = document.getElementById('genre-filter');
    const sortSelect = document.getElementById('sort-select');
    const sortDirectionBtn = document.getElementById('sort-direction');
    const clearFiltersBtn = document.querySelector('.clear-filters');
    const filterTags = document.querySelector('.filter-tags');
    const noResults = document.querySelector('.no-results');
    const songRows = document.querySelectorAll('.song-row');

    // Search functionality
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        state.searchTerm = searchTerm;
        updateResults();
    }

    // Filter functionality
    function updateFilters() {
        const activeFilters = new Set();
        
        // Add selected genre
        if (genreFilter.value) {
            activeFilters.add(`genre:${genreFilter.value}`);
        }

        state.activeFilters = activeFilters;
        updateResults();
        updateFilterTags();
    }

    // Sort functionality
    function updateSort() {
        const sortBy = sortSelect.value;
        const sortDirection = state.sortDirection;
        state.sortBy = sortBy;
        
        const rows = Array.from(songRows);
        rows.sort((a, b) => {
            const aValue = a.dataset[sortBy].toLowerCase();
            const bValue = b.dataset[sortBy].toLowerCase();
            return sortDirection === 'asc' 
                ? aValue.localeCompare(bValue)
                : bValue.localeCompare(aValue);
        });

        const tbody = document.querySelector('.songs-table tbody');
        rows.forEach(row => tbody.appendChild(row));
    }

    // Update results based on current state
    function updateResults() {
        let visibleCount = 0;

        songRows.forEach(row => {
            const title = row.dataset.title.toLowerCase();
            const artist = row.dataset.artist.toLowerCase();
            const album = row.dataset.album.toLowerCase();
            const genre = row.dataset.genre.toLowerCase();

            // Search term filter
            const matchesSearch = !state.searchTerm || 
                title.includes(state.searchTerm) || 
                artist.includes(state.searchTerm) || 
                album.includes(state.searchTerm);

            // Active filters
            const matchesFilters = Array.from(state.activeFilters).every(filter => {
                if (filter.startsWith('genre:')) {
                    return genre === filter.split(':')[1].toLowerCase();
                }
                return true;
            });

            // Show/hide element
            if (matchesSearch && matchesFilters) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide no results message
        noResults.style.display = visibleCount === 0 ? 'flex' : 'none';
    }

    // Update filter tags display
    function updateFilterTags() {
        filterTags.innerHTML = '';
        let hasFilters = false;

        state.activeFilters.forEach(filter => {
            if (filter.startsWith('genre:')) {
                hasFilters = true;
                const genre = filter.split(':')[1];
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.innerHTML = `<i class="fas fa-music"></i> ${genre}`;

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = () => {
                    genreFilter.value = '';
                    updateFilters();
                };

                tag.appendChild(removeBtn);
                filterTags.appendChild(tag);
            }
        });

        clearFiltersBtn.style.display = hasFilters ? 'block' : 'none';
    }

    // Event Listeners
    searchInput.addEventListener('input', performSearch);
    
    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
    });

    genreFilter.addEventListener('change', updateFilters);

    sortSelect.addEventListener('change', () => {
        state.sortBy = sortSelect.value;
        updateSort();
    });

    sortDirectionBtn.addEventListener('click', () => {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        sortDirectionBtn.innerHTML = `<i class="fas fa-sort-amount-${state.sortDirection === 'asc' ? 'down' : 'up'}"></i>`;
        updateSort();
    });

    clearFiltersBtn.addEventListener('click', () => {
        genreFilter.value = '';
        updateFilters();
    });

    // Make rows clickable
    songRows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.closest('button')) return;
            const playBtn = this.querySelector('.play-btn');
            if (playBtn) playBtn.click();
        });
    });

    // Play button functionality
    const playButtons = document.querySelectorAll('.play-btn');
    playButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const songUrl = this.dataset.songUrl;
            const songTitle = this.dataset.songTitle;
            const artist = this.dataset.artist;
            const albumArt = this.dataset.albumArt;
            
            playSong(songUrl, songTitle, artist, albumArt);
            
            playButtons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-play"></i>';
            });
            this.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Update playing state
            songRows.forEach(row => row.classList.remove('playing'));
            this.closest('.song-row').classList.add('playing');
        });
    });

    // Like button functionality
    const likeButtons = document.querySelectorAll('.like-btn');
    likeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            fetch('/bookmark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `item_id=${songId}&item_type=music`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('active');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                    
                    // Update tooltip
                    const tooltip = this.getAttribute('data-tooltip');
                    this.setAttribute('data-tooltip', 
                        tooltip === 'Add to Favorites' ? 'Remove from Favorites' : 'Add to Favorites');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Queue/Playlist button functionality
    const queueButtons = document.querySelectorAll('.queue-btn');
    queueButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const songId = this.dataset.songId;
            fetch('/playlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `song_id=${songId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Visual feedback
                    this.classList.add('added');
                    setTimeout(() => this.classList.remove('added'), 1000);
                    
                    // Update tooltip
                    const tooltip = this.getAttribute('data-tooltip');
                    this.setAttribute('data-tooltip', 'Added to Playlist');
                    setTimeout(() => {
                        this.setAttribute('data-tooltip', tooltip);
                    }, 1000);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Initialize
    updateResults();
    updateFilterTags();
});
</script>
{% endblock %}